<div class="home-navigation">
	<span class="back">Back</span>
	<span class="title">View History</span>
	<span class="sync"></span>
</div>
<div class="home">
	<div class="survey-block">
		<div class="survey-title"></div>
		<div class="home-menu-list">
			<ul id="participant-list">
				
			</ul>
		</div>
	</div>
</div>

<!-- survey history template -->
<script id="groupListHistoryDetailTemplate" type="x-jquery-tmpl">
	<div>
		<div class="date-label">${date}</div>
		<ul id="participant_list_${date}"></ul>
	</div>
</script>

<!-- survey history template -->
<script id="listHistoryDetailTemplate" type="x-jquery-tmpl">
	<li>${interviewCode} | ${participantCode} | ${time} <span class='survey-status ${statusClass}'>${status}</span></li>
</script>

<script>
$(".back").click(function(){
	$("#content").load("static/view/viewSurveys.html");
})
$(function() {
	var participantSurveys = $("body").data("participantSurveys");
	var existingDate = [];
	$.map(participantSurveys,function(participantSurvey){
		if(participantSurvey.getStatus() === 2){
			return;
		}
		var startedDateTime = participantSurvey.getStartDateTime().split(/\s/);
		// pulupate group
		if(existingDate.indexOf(startedDateTime[0]) < 0){
			$(".home-menu-list").append($("#groupListHistoryDetailTemplate").tmpl({date: startedDateTime[0]}));
			existingDate.push(startedDateTime[0]);
		}
		
		var li = $("#listHistoryDetailTemplate").tmpl({
						interviewCode: participantSurvey.getInterviewCode(),
						participantCode: participantSurvey.getParticipantCode(),
						time: getTime(startedDateTime[1]),
						status: participantSurvey.getStatus()  == 0 ? "Incomplete": "Complete",
						statusClass: participantSurvey.getStatus()  == 0 ? "incomplete": ""
						});
		
		participantLogDao.findParticipantLogByParticipantSurvey(participantSurvey.getParticipantSurveyId(),function(participantLog){
			var embededData = {
								lastQuestionId: participantLog.getLastQuestion(),
								lastSectionId: participantLog.getLastSectionId(),
								lastSectionIndex: participantLog.getLastSectionIndex(),
								lastQuestionIndex: participantLog.getLastQuestionIndex(),
								participantLog: participantLog
							  }
			li.data("continueSurvey",embededData);
		});
		
		li.bind("click",function(){
			continueSurvey($(this));
		});
		
		$("#participant_list_" + startedDateTime[0]).append(li);
	});
});

function continueSurvey(li){
	var liData = li.data("continueSurvey");
	questionDao.getBySection(liData.lastSectionId,function(questions){
		$("#participantLog").data("participantLog", liData.participantLog);
		$("body").data("startQuestionData",liData);
		$("body").data("questionaire", {"questions": questions, fromPrevious: false});
		$("#content").load("static/view/questionaire.html");
	});
}

/**
 * @param stringTime
 * return time in format 00h:00mn
 */
function getTime(stringTime){
	var timeArray = stringTime.split(":");
	return timeArray[0] + "h:"+ timeArray[1] + "mn";
}
</script>