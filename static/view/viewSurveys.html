<div class="home-navigation">
	<span class="back-top">Back</span>
	<span class="title">View History</span>
	<span class="backup" id="backup">Backup Data</span>
</div>
<div class="home">
	<div class="survey-block">
		<div class="home-menu-list">
			<ul id="survey-list"></ul>
		</div>
	</div>
</div>

<!-- survey history template -->
<script id="surveyHistoryListTemplate" type="x-jquery-tmpl">
	<li>${description} <span class='survey-status'> ${notSynchronized} ppl | ${readySynchronized} sync</span></li>
</script>

<script>
$(function(){
	
	$("#backup").click(function(){
		showLoadingDialog();
		initFS();
		//read all data from db
		var jsondata = {};
		surveyDao.getAllForBackup(function(surveys){
			jsondata.survey = surveys;
			sectionDao.getAllForBackup(function(sections){
				jsondata.section = sections;
				questionDao.getAllForBackup(function(questions){
					jsondata.question = questions;
					synLogDao.getAllForBackup(function(l){
						jsondata.synlog = l;
						questionTypeDao.getAllForBackup(function(qt){
							jsondata.questiontype = qt;
							provinceDao.getAllForBackup(function(pr){
								jsondata.province = pr;
								participantSurveyDao.getAllForBackup(function(ps){
									jsondata.participantsurvey = ps;
									participantLogDao.getAllForBackup(function(pl){
										jsondata.participantlog = pl;
										participantAnswerDao.getAllForBackup(function(pa){
											jsondata.participantanswer = pa;
											outcomeEvaluationDao.getAllForBackup(function(oc){
												jsondata.outcomeevaluation = oc;
												mobileDao.getAllForBackup(function(m){
													jsondata.mobile = m;
													languageDao.getAllForBackup(function(l){
														jsondata.language = l;
														answerTypeDao.getAllForBackup(function(at){
															jsondata.answertype = at;
															answerDao.getAllForBackup(function(answers){
																jsondata.answer = answers;
																//call the write file function
																backupData(JSON.stringify(jsondata));
															});
														});
													});
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
	surveyDao.getAll(function(surveys) {
		$.each(surveys,function(index,survey){
			var surveyId = survey.getSurveyId();
			var syncState = {
				readySynchronized: 0
			}; 
			synLogDao.countSyncBySurvey(surveyId, function(count){
				syncState.readySynchronized = count;
				participantSurveyDao.countParticipantBySurveyKey(surveyId, function(status){
					syncState.clickEvent = onclick;
					syncState.description = survey.getDescription1();
					syncState.notSynchronized = status.notSync;
					var li = $("#surveyHistoryListTemplate").tmpl(syncState);
					li.bind("click",function(){
						loadHistoryDetail(surveyId,survey.getDescription1());
					});
					$("#survey-list").append(li);
				});
			});
		});
	});
	
	$(".back-top").click(function(){
		$("#content").load("static/view/home.html");
	});
});
function loadHistoryDetail(surveyId,description1) {
	sectionDao.getBySurvey(surveyId, function(sections) {
			$("body").data("sections", sections);
	});
	participantSurveyDao.getBySurvey(surveyId, function(participants) {
		$("body").data("participantSurveys", participants);
		$("#selectedSurvey").data("selectedSurvey", {"surveyId": surveyId, "description": description1});
		$("#content").load("static/view/viewHistoryDetail.html");
	});
}
</script>
